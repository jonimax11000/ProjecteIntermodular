@startuml
!include <C4/C4_Component>

title Nivel 3 - Diagrama de Components - API Continguts (ExpressJS - Port 3000)

Container_Boundary(api_continguts, "API Continguts", "ExpressJS", "Servei de streaming HLS")

' === COMPONENTS PRINCIPALS ===
Component(stream_controller, "StreamController", "Express Router", "Ruta /stream/*")
Component(video_controller, "VideoController", "Express Router", "Ruta /api/videos")
Component(auth_middleware, "AuthMiddleware", "Middleware", "Validació JWT per a pujades")
Component(stream_auth, "StreamAuth", "Middleware", "Validació tokens de streaming")

Component(hls_generator, "HLSGenerator", "Streaming Engine", "Genera playlists i segments .ts")
Component(video_processor, "VideoProcessor", "FFmpeg Wrapper", "Transcodifica vídeos a HLS")
Component(thumbnail_generator, "ThumbnailGenerator", "Image Processing", "Genera miniatures automàtiques")

Component(video_storage, "VideoStorage", "File System", "Accés a emmagatzematge de vídeos")
Component(subtitles_manager, "SubtitlesManager", "SRT/VTT", "Gestió de subtítols i capçaleres")
Component(metadata_updater, "MetadataUpdater", "MongoDB Client", "Actualització de metadades en temps real")

Component(cdn_sync, "CDNSync", "CDN Manager", "Sincronització amb CloudFront/Akamai")
Component(drm_service, "DRMService", "Widevine/PlayReady", "Xifrat i gestió de DRM")
Component(analytics_service, "AnalyticsService", "Metrics", "Estadístiques de reproducció")

' === EMMAGATZEMATGES ===
Container(internal_videos, "Emmagatzematge de Vídeos", "Sistema de Fitxers", "Vídeos en format HLS")
ContainerDb(mongodb_db, "Base de Dades Historial", "MongoDB", "Metadades de reproducció")

' === RELACIONS INTERNES ===
stream_controller --> stream_auth : "Validació token streaming"\n//<size:10>[middleware]</size>//
video_controller --> auth_middleware : "Validació JWT per pujades"\n//<size:10>[middleware]</size>//

stream_controller --> hls_generator : "Sol·licita streaming"
video_controller --> video_processor : "Inicia processament"
video_controller --> thumbnail_generator : "Genera miniatures"

hls_generator --> video_storage : "Llegeix segments de vídeo"\n//<size:10>[fs.createReadStream]</size>//
video_processor --> video_storage : "Escriu vídeos processats"\n//<size:10>[fs.createWriteStream]</size>//
thumbnail_generator --> video_storage : "Guarda miniatures"\n//<size:10>[fs]</size>//

hls_generator --> metadata_updater : "Actualitza començament reproducció"
metadata_updater --> mongodb_db : "Emmagatzema metadades"\n//<size:10>[Mongoose (27017)]</size>//
analytics_service --> mongodb_db : "Registra estadístiques"\n//<size:10>[Mongoose]</size>//

hls_generator --> drm_service : "Aplica xifrat"\n//<size:10>[AES-128]</size>//
video_processor --> cdn_sync : "Notifica nou contingut"
cdn_sync --> video_storage : "Sincronitza amb CDN"\n//<size:10>[rsync/API]</size>//

' === CONNEXIONS EXTERNES ===
stream_controller -[#blue]u-> "Streaming HLS" : "HTTP/HTTPS"\n//<size:10>[Port: 3000]</size>//
video_controller -[#blue]u-> "Gestió de Vídeos" : "HTTPS/JWT"\n//<size:10>[Port: 3000]</size>//
api_continguts -[#green]d-> internal_videos : "Accés a vídeos"\n//<size:10>[Sistema de fitxers]</size>//
api_continguts -[#green]d-> mongodb_db : "Actualització metadades"\n//<size:10>[Mongoose (27017)]</size>//

' === CONNEXIONS AMB ALTRES SISTEMES ===
api_continguts -[#orange]r-> "API Catàleg" : "Notifica vídeo processat"\n//<size:10>[HTTP]</size>//
api_continguts -[#orange]r-> "API Subscripcions" : "Verifica DRM per subscriptors"\n//<size:10>[HTTP]</size>//

@enduml